### 1. ec2 키페어 생성 ###

https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/create-key-pairs.html

### 2.kubectl 설치하기 ###

```
$ curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.24.7/2022-10-31/bin/darwin/amd64/kubectl
$ chmod +x ./kubectl
$ mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$HOME/bin:$PATH
$ kubectl version --short --client
```

### 3. eksctl 설치하기 ###

```
$ /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
$ brew upgrade eksctl && { brew link --overwrite eksctl; } || { brew tap weaveworks/tap; brew install weaveworks/tap/eksctl; }
$ eksctl version
0.127.0
```


### 4. eks 클러스터 생성 ###

cluster.yaml 파일을 생성한다.
```
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: spark-on-eks
  region: ap-northeast-2

nodeGroups:
  - name: spark-ng-x86 
    instanceType: m6i.2xlarge
    minSize: 2
    maxSize: 5
    desiredCapacity: 3
    volumeSize: 80
    ssh: # use existing EC2 key
      publicKeyName: aws-kp
  - name: spark-ng-arm
    instanceType: m6g.2xlarge
    minSize: 2
    maxSize: 5
    desiredCapacity: 3
    volumeSize: 80
    ssh: # use existing EC2 key
      publicKeyName: aws-kp
```

아래 명령어를 이용하여 새로운 클러스터를 하나 생성한다.
```
$ eksctl utils update-coredns --cluster=spark-on-eks
$ eksctl utils update-kube-proxy --cluster=spark-on-eks --approve
$ eksctl utils update-aws-node --cluster=spark-on-eks --approve

$ eksctl create cluster -f cluster.yaml
```
VPC 를 비롯한 서브넷, 시큐리티 그룹 등과 같은 AWS 리소스가 자동으로 생성된다.

[참고] 클러스터 삭제 명령어
```
$ eksctl delete cluster -f cluster.yaml
```



### 4. 클러스터 생성 확인 ###
```
$ kubectl get nodes -o wide
NAME                                                STATUS   ROLES    AGE     VERSION
ip-192-168-31-233.ap-northeast-2.compute.internal   Ready    <none>   4m10s   v1.24.9-eks-49d8fe8
ip-192-168-60-56.ap-northeast-2.compute.internal    Ready    <none>   4m8s    v1.24.9-eks-49d8fe8
$
$ kubectl get pods -A -o wide
NAMESPACE     NAME                      READY   STATUS    RESTARTS   AGE
kube-system   aws-node-l7b4d            1/1     Running   0          4m28s
kube-system   aws-node-z8l8s            1/1     Running   0          4m26s
kube-system   coredns-dc4979556-mp8vm   1/1     Running   0          12m
kube-system   coredns-dc4979556-p547d   1/1     Running   0          12m
kube-system   kube-proxy-4lz65          1/1     Running   0          4m28s
kube-system   kube-proxy-j4fpj          1/1     Running   0          4m26s
```

self-managed 노드 그룹의 경우, AWS 콘솔의 노드 그룹 리스트에 정보가 나오지 않는다.

![](https://github.com/gnosia93/spark-on-eks/blob/main/images/eks-nodegroup-2.png)


## 참고자료 ##
* https://eksctl.io/usage/creating-and-managing-clusters/
* https://stackoverflow.com/questions/64059038/the-results-of-aws-eks-list-nodegroups-and-eksctl-get-nodegroups-are-inconsi
* https://findstar.pe.kr/2022/08/21/which-instance-type-is-right-for-EKS/
